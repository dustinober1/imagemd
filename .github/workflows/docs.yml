name: Documentation

on:
  push:
    branches: [ main ]
    paths: [ 'docs/**', 'vision_pdf/**' ]
  pull_request:
    branches: [ main ]
    paths: [ 'docs/**' ]

jobs:
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-docs-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-docs-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[docs]

    - name: Build documentation
      run: |
        cd docs/
        make html

    - name: Check documentation build
      run: |
        cd docs/
        if [ ! -f "_build/html/index.html" ]; then
          echo "Documentation build failed - index.html not found"
          exit 1
        fi
        echo "Documentation built successfully"

    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v3
      with:
        name: documentation
        path: docs/_build/html/
        retention-days: 30

  test-docs:
    name: Test Documentation
    runs-on: ubuntu-latest
    needs: build-docs

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[docs]

    - name: Test documentation examples
      run: |
        cd docs/
        # Test that all code examples in documentation are syntactically correct
        python -m doctest source/*.rst
        python -m doctest source/*/*.rst

    - name: Check links
      run: |
        cd docs/
        # Check for broken links in documentation
        make linkcheck

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [build-docs, test-docs]
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[docs]

    - name: Build documentation
      run: |
        cd docs/
        make html

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/_build/html
        cname: visionpdf.github.io
        keep_files: true

    - name: Create Documentation Summary
      run: |
        echo "## ðŸ“š Documentation Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ **Live Documentation:** https://visionpdf.github.io/vision-pdf/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Documentation Contents:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… User Guide" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… API Reference" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Installation Instructions" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Code Examples" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Developer Guide" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Quick Links:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“– [User Guide](https://visionpdf.github.io/vision-pdf/)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ [API Reference](https://visionpdf.github.io/vision-pdf/api/)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¥ [Installation](https://visionpdf.github.io/vision-pdf/installation.html)" >> $GITHUB_STEP_SUMMARY

  api-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest
    needs: build-docs

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[docs,api]

    - name: Generate API docs
      run: |
        # Generate OpenAPI specification
        python -c "
        import json
        from vision_pdf.api.main import app
        with open('api-schema.json', 'w') as f:
            json.dump(app.openapi(), f, indent=2)
        "

    - name: Upload API schema
      uses: actions/upload-artifact@v3
      with:
        name: api-schema
        path: api-schema.json
        retention-days: 30